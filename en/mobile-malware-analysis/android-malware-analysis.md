# Android Malware Analysis

The section will provide a high level process for analyzing Android malware and examples will leverage the NowSecure Platform.

# Identifying known malware
**Note** *These bullet points are merely informative* 

## YARA, * Using Yara rules
	* Explain how it works
	* Show some cases
	* Create a new rule for a known malware

* Androguard malware database
	* Explain how it works
	* Show few cases
	* Create a new rule for a known malware

# First encounter - Creating a safe environment
The most important step before analyzing a piece of malware, is to setup a controlled environment where the sample can be triggered and its behavior analyzed.

If the setup is done correctly, it will help the analyst to obtain a strong knowledge of the functionalities and behavior implemented within the malware. However, in order to obtain a complete understanding of the malware's logic, a static and dynamic analysis are required. This is the real path to analyze and disassembly a piece of malware.

The purpose of this section, is to describe in details how to configure and prepare a laboratory for analyzing different types of malware, no previous experience is required, as our intention is to keep it as simple and minimalistic as possible.

*[Keep adding introductory paragrpahs]*

## Setting up the emulator
### Introduction
Nowadays, the growth that Android has suffered is considerable, and the alternatives out there in the market to setup an emulator are numerous. Like everything else, each one has their advantages and disadvantages, being the user the one who has to decide which one fills his needs.

Obviously, not all of them offer the same functionalities, and their use is focalized to different purposes that might not be in line with actual needs. The list is in continous expansion, however we attempted to narrow it to the most significant ones:

#### Android SDK / AVD
The Android SDK includes a device emulator that runs on the computer.  The Android emulator mimics all the hardware and software features of a traditional and real mobile device, except that it is not capable of perform phone calls, or make a proper use of NFC capabilities (*Are we sure of this?*)

*[Insert screenshot]*

The emulator makes use of Android Virtual Device (AVD) configurations, that let the user defines specific hardware aspects, and allow to create multiple configurations to test numerous Android platforms and hardware combinations.

It runs a full Android system stack, from user to kernel level. There are multiple Android system images available through the Android SDK Manager, which contain code for the Android Linux Kernel, the Dalvik VM, the native libraries, and various Android packages. Moreover, the emulator provides dynamic binary translation of device machine code to the operating system, and processor architecture of the development machine.

**Advantages**

* Full Android system stack
* Flexible, multiple configurations

**Disadvantages**

* No phone calls
* No NFC capabilities

*This is just an example, no needs to be here necessarily, maybe using a table?*

#### Android-x86
Is an unofficial initiative which aims to port Google's Android Mobile operating system to run on devices configured by AMD and Intel x86 processors. The OS is based on the Android Open Source Project, with minor modifications necessary to run it on PC architecture.

There are minor low-level components replaced to obtain a better performance, such as the kernel (*it runs on the long-term Linux Kernel available*), and Bionic library (*some components are replaced with others from GCC*).

**Note** *Drop few more paragraphs on Android-x86*

**Advantages**
* Android system can runs on a PC architecture.

**Disadvantages**
* Most dynamic utilities don't work on a PC architecture.

### Using the emulator
Different alternatives to emulate an Android device have been commented few sections above, however, the needs that are going to be covered in this section require to emulate an Android device using the official Android SDK/AVD.

An Android Virtual Device (AVD) is basically an emulator configuration that lets the analyst to recreate an actual device by specifying hardware and software options that will be emulated by the Android Emulator.

There are plenty ways to create an AVD, but the easiest one is to use the graphical AVD Manager, which can be located in Android Studio by clicking *Tools > Android > AVD Manager*

The four fundamental pillars that compose an AVD emulator are:

* **Hardware profile** - Contains the hardware characteristics of the virtual device. Is the place where you define how much memory it has, SD card storage, and so on.

* **Storage area on the computer** - Used as device's user data and SD Card. Applications will be installed in this area.

* **System image** - Defines the version of Android that will run on the Android emulator.

* **Miscellaneous** - Options like the SD card that is going to be used by the virtual device, or its skin, where other parameters like screen dimension, keys, appearance, etc. can be controlled.

### Creating an AVD with AVD Manager
The AVD Manager can be launched either:

* In Android Studio, by clicking *Tools > Android > AVD Manager*.
* Using the command line and navigate to the SDK's *tools/* directory and execute: ``$ android avd``

![AVD Manager](avd.png)

To effectively deploy our tools and conduct the tests, the AVD created should be running latests version of Android, and have enough memory and space to run the applications without interruptions nor malfunctions.

Before creating the virtual device, lets going to check if all the dependencies and libraries are satisfied for the specific API. For that purpose, open the Android SDK Manager, and make sure to install Android.4.4.2 (API 19).

![title](figure1.png)

Right after solving all the dependencies, it is time to create our first AVD:

1. From the main screen (Figure 1), click **Create...** button.
2. Select a proper device configuration, such as Nexus 5 in this case, then click  **Ok**

![Creating a new Virtual Device](figure2.png)

3.  A new item should appear in the list of AVDs, select the one created recently and press the **Start** button.
![Launching a specific virtual device](figure3.png)

### Creating an AVD from command line
*Are we interested on explaining something like this?*

* How to analyze a malware with the emulator

## Using a real device
* Introduction
* Main advantages and disadvantages
* Which is the best device?
* Configuring the device
* How to analyze a malware with the device

# Exploring your toolset and techniques



#### Dex2Jar
Is a toolset to work with Android .dex and Java .class files. However, its main use is to convert Android's .dex format to Java's .class format,, ready to be analyzed with third parties utilities.

For more advanced users, they can give a try to these utilities:

* **dex-reader/writer** Read/Write the Dalvik Executable file.
*  **d2j-dex2jar** Convert .dex file to .class files.
*  **smali/baksmali** Disassemble dex to smali files and assemble dex from smali files
*  **d2j-decrypt-string** Utility constructed to defeat a specific strings encryption mechanism.

*[Include example on how to decompile classes.dex file]*

#### Dexter
#### Anubis
#### Android Decompiler (JEB)
#### IDA Pro
#### APKInspector

* What are best practices when reverse engineering/analyzing a piece of malware
	* Might be interesting to create a bullet point where best practices are described, brief, concise and clear


# Analyzing a real case
* Analyze a piece of malware from Hacking team, for example, created on purpose to perform surveillance.


